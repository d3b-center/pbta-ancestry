---
title: "PBTA Ancestry Treatment Analysis: Chemotherapy"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Ryan Corbett
date: 2022
params:
  plot_ci: TRUE
---

**Purpose:** 

Assess chemotherapy treatment frequencies in PBTA ancestry cohort, and assess differences in treatment frequency by predicted ancestry

## Usage 

Uses a wrapper function (`survival_analysis`) from utils folder. 

## Setup

#### Packages and functions

Read in set up script.

```{r Set up library}
library(survival)
library(ggpubr)
library(tidyverse)
library(openxlsx)
# Set directories
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "treatment")

# Magrittr pipe
`%>%` <- dplyr::`%>%`

source(file.path(root_dir, "analyses", "survival", "util", "survival_models.R"))
```

#### Set up files and directories

Set up output directories. 

```{r Set up directories}
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results")
plots_dir <- file.path(analysis_dir, "plots")
```

Make output directories.

```{r Make output directories}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

Declare input file paths
```{r Set input file paths}
ancestry_file <- file.path(root_dir, "analyses", "survival", "results", "merged_ancestry_histology_survival.tsv")

trt_file <- file.path(input_dir, "treatment_09152023.tsv")

pnoc_pt_file <- file.path(input_dir, "pnoc-pts.tsv")
```

Wrangle data
```{r}
ancestry <- read_tsv(ancestry_file)

trt <- read_tsv(trt_file)

pnoc <- read_tsv(pnoc_pt_file)
```

Define dfs for chemo trt containing only patients in ancestry cohort
```{r}
chemo_trt <- trt %>%
  filter(cbtn_subject_id %in% ancestry$cohort_participant_id) %>%
  dplyr::select(cbtn_subject_id, chemotherapy, chemotherapy_type,
                age_at_chemo_start) %>%
  dplyr::rename(cohort_participant_id = cbtn_subject_id)

```

identify patients receiving chemo and that are enrolled on a clinical trial

```{r}
upfront_enrolled <- chemo_trt %>%
  dplyr::arrange(as.numeric(age_at_chemo_start)) %>%
  distinct(cohort_participant_id, .keep_all = T) %>%
  dplyr::filter(chemotherapy == "Yes" & grepl("is enrolled on a protocol", chemotherapy_type)) %>%
  pull(cohort_participant_id)

overall_enrolled <- chemo_trt %>%
  filter(chemotherapy == "Yes" & grepl("is enrolled on a protocol", chemotherapy_type)) %>%
  pull(cohort_participant_id)

# PNOC patients are enrolled in clinical trials 
pnoc_pts <- pnoc %>%
  pull(cohort_participant_id)
```

add columns to `ancestry` indicating if patients received chemo and are enrolled in a protocol
```{r}
ancestry <- ancestry %>%
  dplyr::mutate(upfront_enrolled = case_when(
    cohort_participant_id %in% c(upfront_enrolled, pnoc_pts) ~ "Yes",
    TRUE ~ "No"
  )) %>%
  dplyr::mutate(overall_enrolled = case_when(
    cohort_participant_id %in% c(overall_enrolled, pnoc_pts) ~ "Yes",
    TRUE ~ "No"
  ))
  
upfront_ct <- table(ancestry$predicted_ancestry, 
                     ancestry$upfront_enrolled)
upfront_ct

enrolled_ct <- table(ancestry$predicted_ancestry, 
                     ancestry$overall_enrolled)
enrolled_ct
```


```{r}
round(apply(upfront_ct, 2, function(x) x/table(ancestry$predicted_ancestry)), 2)

round(apply(enrolled_ct, 2, function(x) x/table(ancestry$predicted_ancestry)), 2)

```

Is there any evidence for non-random association between predicted ancestry and proportion of pts receiving chemo or enrolled in a protocol? 
```{r}
chisq.test(table(ancestry$predicted_ancestry, 
      ancestry$upfront_enrolled))

chisq.test(table(ancestry$predicted_ancestry, 
      ancestry$overall_enrolled))
```

Is there any evidence for non-random association between EUR vs. non-EUR and proportion of pts receiving chemo or enrolled in a protocol? 
```{r}
chisq.test(table(ancestry$EUR_status, 
      ancestry$upfront_enrolled))

chisq.test(table(ancestry$EUR_status, 
      ancestry$overall_enrolled))
```

```{r}

upfront_no_pnoc_ct <- table(ancestry$predicted_ancestry[!ancestry$cohort_participant_id %in% pnoc_pts], 
                     ancestry$upfront_enrolled[!ancestry$cohort_participant_id %in% pnoc_pts])

round(apply(upfront_no_pnoc_ct, 2, function(x) x/table(ancestry$predicted_ancestry[!ancestry$cohort_participant_id %in% pnoc_pts])), 2)

chisq.test(table(ancestry$predicted_ancestry[!ancestry$cohort_participant_id %in% pnoc_pts], 
                     ancestry$upfront_enrolled[!ancestry$cohort_participant_id %in% pnoc_pts]))

```


```{r}
upfront_by_hist <- table(ancestry$plot_group[ancestry$upfront_enrolled == "Yes"],
                          ancestry$predicted_ancestry[ancestry$upfront_enrolled == "Yes"])

total_hist <- table(ancestry$plot_group, ancestry$predicted_ancestry)
total_hist <- total_hist[rownames(total_hist) %in% rownames(upfront_by_hist)]

upfront_by_hist_freq <- round(upfront_by_hist/total_hist*100, 0)

upfront_by_hist_full <- matrix(glue::glue("{upfront_by_hist} ({upfront_by_hist_freq}%)"),
                                nrow(upfront_by_hist), ncol(upfront_by_hist),
                                dimnames = list(rownames(upfront_by_hist),
                                                colnames(upfront_by_hist)))

upfront_by_hist_full[upfront_by_hist_full %in% c("0 (NaN%)")] <- "--"
upfront_by_hist_full[upfront_by_hist_full %in% c("0 (0%)")] <- "0"

```


```{r}
groups <- unique(ancestry$plot_group)
groups <- groups[!grepl("Meningioma|Oligodendroglioma|neoplastic", groups) & !is.na(groups)]

upfront_pval <- rep(0, length(groups))
names(upfront_pval) <- groups

for (group in groups) {
  
  upfront_pval[group] <- round(fisher.test(table(ancestry$predicted_ancestry[ancestry$plot_group == group], 
                                     ancestry$upfront_enrolled[ancestry$plot_group == group]))$p.value, 3)
  
}

```


```{r}
upfront_by_hist_full <- upfront_by_hist_full %>%
  as.data.frame() %>%
  dplyr::mutate(pvalue = unlist(upfront_pval[order(names(upfront_pval))])) %>%
  dplyr::mutate(plot_group = names(upfront_pval[order(names(upfront_pval))])) %>%
  relocate(plot_group) %>%
  write_tsv(file.path(results_dir, "freq-upront-enrollment-by-ancestry-histology.tsv"))

```



```{r}
enrolled_by_hist <- table(ancestry$plot_group[ancestry$overall_enrolled == "Enrolled"],
                          ancestry$predicted_ancestry[ancestry$overall_enrolled == "Enrolled"])

total_hist <- table(ancestry$plot_group, ancestry$predicted_ancestry)
total_hist <- total_hist[rownames(total_hist) %in% rownames(enrolled_by_hist)]

enrolled_by_hist_freq <- round(enrolled_by_hist/total_hist*100, 1)

enrolled_by_hist_full <- matrix(glue::glue("{enrolled_by_hist} ({enrolled_by_hist_freq}%)"),
                                nrow(enrolled_by_hist), ncol(enrolled_by_hist),
                                dimnames = list(rownames(enrolled_by_hist),
                                                colnames(enrolled_by_hist)))

enrolled_by_hist_full[enrolled_by_hist_full %in% c("0 (NaN%)")] <- "--"
enrolled_by_hist_full[enrolled_by_hist_full %in% c("0 (0%)")] <- "0"


```

Difference in % enrolled by histology? 

```{r}
groups <- unique(ancestry$plot_group)
groups <- groups[groups %in% rownames(enrolled_by_hist)]

enrolled_pval <- rep(0, length(groups))
names(enrolled_pval) <- groups

for (group in groups) {
  
  enrolled_pval[group] <- round(fisher.test(table(ancestry$predicted_ancestry[ancestry$plot_group == group], 
                                     ancestry$overall_enrolled[ancestry$plot_group == group]))$p.value, 3)
  
}
```

```{r}
enrolled_by_hist_full <- enrolled_by_hist_full %>%
  as.data.frame() %>%
  dplyr::mutate(pvalue = unlist(enrolled_pval[order(names(enrolled_pval))])) %>%
  dplyr::mutate(plot_group = names(enrolled_pval[order(names(enrolled_pval))])) %>%
  relocate(plot_group) %>%
  write_tsv(file.path(results_dir, "freq-overall-enrolled-protocol-by-ancestry-histology.tsv"))

``` 
 
 
```{r}
write_tsv(ancestry,
          file.path(results_dir, "merged_ancestry_histology_survival_chemo_trt.tsv"))

```




```{r}
ancestry <- ancestry %>%
  dplyr::mutate(predicted_ancestry = factor(predicted_ancestry,
                                            levels = c("EUR", "AFR", "AMR", "EAS", "SAS")
                                            ))

epn <- ancestry %>%
  dplyr::filter(plot_group == "Ependymoma") %>%
  dplyr::mutate(mol_sub_group = fct_relevel(mol_sub_group,
                      c("EPN, ST ZFTA", "EPN, ST YAP1", "EPN, PF A", 
                        "EPN, PF B", "EPN, MPE", "EPN, SP", "EPN, SP-MYCN",
                        "EPN, To be classified")))

epn_trt_model_os <- fit_save_model(epn[!grepl("classified", epn$mol_sub_group),],
                                    terms = "predicted_ancestry+overall_enrolled",
               file.path(results_dir, "coxph_epn_os_subtype_age_ancestry_chemo.RDS"),
               "multivariate",
               years_col = "OS_years", status_col = "OS_years"
              )

readRDS(file.path(results_dir, "coxph_epn_os_subtype_age_ancestry_chemo.RDS"))

```


```{r}

mes <- ancestry %>%
  dplyr::filter(plot_group == "Mesenchymal tumor") %>%
  dplyr::mutate(cancer_group = case_when(
    grepl("Sarcoma|Ewing|Hemangioblastoma|Chordoma", cancer_group) ~ cancer_group,
    TRUE ~ "Other"
  )) %>%
  # dplyr::mutate(cancer_group = fct_relevel(cancer_group,
  #                                          c("Chordoma", "Chondromyxoid fibroma",
  #                                            "Ewing sarcoma", "Hemangioblastoma",
  #                                            "Inflammatory Myofibroblastic Tumor",
  #                                            "Mesenchymal tumor", "Sarcoma"))) %>%
  dplyr::mutate(cancer_group = fct_relevel(cancer_group,
                                           c("Chordoma",
                                             "Ewing sarcoma", "Hemangioblastoma",
                                             "Sarcoma", "Other")))

mes_trt_model_os <- fit_save_model(mes,
                                    terms = "age_at_diagnosis_years+EUR_status+overall_enrolled",
               file.path(results_dir, "coxph_mes_os_subtype_age_ancestry_chemo.RDS"),
               "multivariate",
               years_col = "EFS_years", status_col = "EFS_status"
              )

readRDS(file.path(results_dir, "coxph_mes_os_subtype_age_ancestry_chemo.RDS"))



```
