---
title: "PBTA Ancestry Treatment Analysis: Radiation"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Ryan Corbett
date: 2022
params:
  plot_ci: TRUE
---

**Purpose:** 

Assess radiation treatment frequencies in PBTA ancestry cohort, and assess differences in treatment frequency by predicted ancestry

## Usage 

Uses a wrapper function (`survival_analysis`) from utils folder. 

## Setup

#### Packages and functions

Read in set up script.

```{r Set up library}
library(survival)
library(ggpubr)
library(tidyverse)
library(openxlsx)
# Set directories
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analysis_dir <- file.path(root_dir, "analyses", "treatment")

# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

#### Set up files and directories

Set up output directories. 

```{r Set up directories}
input_dir <- file.path(analysis_dir, "input")
results_dir <- file.path(analysis_dir, "results")
plots_dir <- file.path(analysis_dir, "plots")
```

Make output directories.

```{r Make output directories}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

Declare input file paths
```{r Set input file paths}
ancestry_file <- file.path(results_dir, "merged_ancestry_histology_survival_chemo_trt.tsv")

trt_file <- file.path(input_dir, "treatment_09152023.tsv")

pnoc_pt_file <- file.path(input_dir, "pnoc-pts.tsv")
```

Wrangle data
```{r}
ancestry <- read_tsv(ancestry_file)

trt <- read_tsv(trt_file)

pnoc <- read_tsv(pnoc_pt_file)
```

Define dfs for radiation trt info in ancestry cohort
```{r}
radiation_trt <- trt %>%
  arrange(as.numeric(age_at_radiation_start)) %>%
  distinct(cbtn_subject_id, .keep_all = TRUE) %>%
  dplyr::select(cbtn_subject_id, radiation, radiation_type,
                age_at_radiation_start) %>%
  dplyr::rename(cohort_participant_id = cbtn_subject_id)

```


```{r}
# PNOC patients are enrolled in clinical trials 
pnoc_pts <- pnoc %>%
  pull(cohort_participant_id)
```


```{r}
ancestry <- ancestry %>%
  dplyr::filter(!cohort_participant_id %in% pnoc_pts) %>%
  left_join(radiation_trt[,c("cohort_participant_id", "radiation", "radiation_type")]) %>%
  dplyr::mutate(radiation = case_when(
    radiation == "Yes" ~ "Yes",
    TRUE ~ "No"
  ))

```


```{r}
radiation_anc_p <- round(chisq.test(table(ancestry$predicted_ancestry,
                  ancestry$radiation))$p.value, 3)

photon_anc_p <- round(fisher.test(table(ancestry$predicted_ancestry[ancestry$radiation == "Yes"],
                   ancestry$radiation_type[ancestry$radiation == "Yes"] == "Photons"))$p.value, 3)

proton_anc_p <- round(fisher.test(table(ancestry$predicted_ancestry[ancestry$radiation == "Yes"],
                   ancestry$radiation_type[ancestry$radiation == "Yes"] == "Protons"))$p.value, 3)

```

```{r}
radiation_anc_df <- data.frame(row.names = c("AFR", "AMR", "EAS", "EUR", "SAS"),
                 total_ct = as.vector(table(ancestry$predicted_ancestry)),
                 radiation_ct = as.vector(table(ancestry$predicted_ancestry[ancestry$radiation == "Yes"])),
                 proton_ct = as.vector(table(ancestry$predicted_ancestry[ancestry$radiation_type == "Protons"])),
                 photon_ct = as.vector(table(ancestry$predicted_ancestry[ancestry$radiation_type == "Photons"])))

radiation_anc_df <- radiation_anc_df %>%
  dplyr::mutate(radiation_freq = glue::glue("{radiation_ct} ({round(radiation_ct/total_ct*100, 1)}%)")) %>%
  dplyr::mutate(proton_freq = glue::glue("{proton_ct} ({round(proton_ct/radiation_ct*100, 1)}%)")) %>%
  dplyr::mutate(photon_freq = glue::glue("{photon_ct} ({round(photon_ct/radiation_ct*100, 1)}%)")) %>%
  dplyr::select(total_ct, radiation_freq,
                proton_freq, photon_freq) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::mutate("pval" = c(NA_character_, radiation_anc_p, proton_anc_p, photon_anc_p))

```

```{r}
proton_by_hist <- table(ancestry$plot_group[ancestry$radiation_type == "Protons"],
                          ancestry$predicted_ancestry[ancestry$radiation_type == "Protons"])

total_hist <- table(ancestry$plot_group, ancestry$predicted_ancestry)
total_hist <- total_hist[rownames(total_hist) %in% rownames(proton_by_hist)]

proton_by_hist_freq <- round(proton_by_hist/total_hist*100, 0)

proton_by_hist_full <- matrix(glue::glue("{proton_by_hist} ({proton_by_hist_freq}%)"),
                                nrow(proton_by_hist), ncol(proton_by_hist),
                                dimnames = list(rownames(proton_by_hist),
                                                colnames(proton_by_hist)))

proton_by_hist_full[proton_by_hist_full %in% c("0 (NaN%)")] <- "--"
proton_by_hist_full[proton_by_hist_full %in% c("0 (0%)")] <- "0"

```

```{r}

groups <- unique(ancestry$plot_group)
groups <- groups[groups %in% rownames(proton_by_hist_full)]

proton_pval <- rep(0, length(groups))
names(proton_pval) <- groups

for (group in groups) {
  
  proton_pval[group] <- try(round(fisher.test(table(ancestry$predicted_ancestry[ancestry$plot_group == group & ancestry$radiation == "Yes"], 
                                     ancestry$radiation_type[ancestry$plot_group == group & ancestry$radiation == "Yes"] == "Protons"))$p.value, 3))
  
}

proton_pval <- as.numeric(proton_pval)
names(proton_pval) <- groups

```

```{r}

photon_by_hist <- table(ancestry$plot_group[ancestry$radiation_type == "Photons"],
                          ancestry$predicted_ancestry[ancestry$radiation_type == "Photons"])

total_hist <- table(ancestry$plot_group, ancestry$predicted_ancestry)
total_hist <- total_hist[rownames(total_hist) %in% rownames(photon_by_hist)]

photon_by_hist_freq <- round(photon_by_hist/total_hist*100, 0)

photon_by_hist_full <- matrix(glue::glue("{photon_by_hist} ({photon_by_hist_freq}%)"),
                                nrow(photon_by_hist), ncol(photon_by_hist),
                                dimnames = list(rownames(photon_by_hist),
                                                colnames(photon_by_hist)))

photon_by_hist_full[photon_by_hist_full %in% c("0 (NaN%)")] <- "--"
photon_by_hist_full[photon_by_hist_full %in% c("0 (0%)")] <- "0"

```

```{r}

groups <- unique(ancestry$plot_group)
groups <- groups[groups %in% rownames(photon_by_hist_full)]

photon_pval <- rep(0, length(groups))
names(photon_pval) <- groups

for (group in groups) {
  
  photon_pval[group] <- try(round(fisher.test(table(ancestry$predicted_ancestry[ancestry$plot_group == group & ancestry$radiation == "Yes"], 
                                     ancestry$radiation_type[ancestry$plot_group == group & ancestry$radiation == "Yes"] == "Photons"))$p.value, 3))
  
}

photon_pval <- as.numeric(photon_pval)
names(photon_pval) <- groups

```


```{r}
photon_by_hist_full <- photon_by_hist_full %>%
  as.data.frame() %>%
  dplyr::mutate(pvalue = unlist(photon_pval[order(names(photon_pval))])) %>%
  dplyr::mutate(plot_group = names(photon_pval[order(names(photon_pval))])) %>%
  relocate(plot_group) %>%
  write_tsv(file.path(results_dir, "freq-photon-radiation-by-ancestry-histology.tsv"))

```


```{r}
proton_by_hist_full <- proton_by_hist_full %>%
  as.data.frame() %>%
  dplyr::mutate(pvalue = unlist(proton_pval[order(names(proton_pval))])) %>%
  dplyr::mutate(plot_group = names(proton_pval[order(names(proton_pval))])) %>%
  relocate(plot_group) %>%
  write_tsv(file.path(results_dir, "freq-proton-radiation-by-ancestry-histology.tsv"))

```




```{r}

groups <- unique(ancestry$plot_group[!is.na(ancestry$plot_group) & !grepl("Germ|Oligo|Choroid|Neurofibroma|neoplastic", ancestry$plot_group)])

radiation_df_list <- list()

for (group in groups) {
  
  group_hist <- ancestry %>%
    dplyr::filter(plot_group == group) %>%
    dplyr::mutate(predicted_ancestry = factor(predicted_ancestry, 
                                              levels = c("AFR", "AMR", "EAS", "EUR", "SAS")))
  
  radiation_p <- round(fisher.test(table(group_hist$predicted_ancestry,
                    group_hist$radiation == "Yes"))$p.value, 3)
  
  photon_p <- round(fisher.test(table(group_hist$predicted_ancestry[group_hist$radiation == "Yes"],
                     group_hist$radiation_type[group_hist$radiation == "Yes"] == "Photons"))$p.value, 3)
  
  proton_p <- round(fisher.test(table(group_hist$predicted_ancestry[group_hist$radiation == "Yes"],
                     group_hist$radiation_type[group_hist$radiation == "Yes"] == "Protons"))$p.value, 3)
  
  df <- data.frame(row.names = c("AFR", "AMR", "EAS", "EUR", "SAS"),
                 total_ct = as.vector(table(group_hist$predicted_ancestry)),
                 radiation_ct = as.vector(table(group_hist$predicted_ancestry[group_hist$radiation == "Yes"])),
                 proton_ct = as.vector(table(group_hist$predicted_ancestry[group_hist$radiation_type == "Protons"])),
                 photon_ct = as.vector(table(group_hist$predicted_ancestry[group_hist$radiation_type == "Photons"])))

  radiation_df_list[[group]] <- df %>%
    dplyr::mutate(radiation_freq = glue::glue("{radiation_ct} ({round(radiation_ct/total_ct*100, 1)}%)")) %>%
    dplyr::mutate(proton_freq = glue::glue("{proton_ct} ({round(proton_ct/radiation_ct*100, 1)}%)")) %>%
    dplyr::mutate(photon_freq = glue::glue("{photon_ct} ({round(photon_ct/radiation_ct*100, 1)}%)")) %>%
    dplyr::select(total_ct, radiation_freq,
                  proton_freq, photon_freq) %>%
    t() %>%
    as.data.frame() %>%
    dplyr::mutate("pval" = c(NA_character_, radiation_p, proton_p, photon_p))
  
}

```

```{r}

write_tsv(ancestry, 
          file.path(results_dir, "merged_ancestry_histology_survival_chemo_radiation_trt.tsv"))


```

