---
title: 'Assess BRAF fusion breakpoints in PBTA ancestry cohort'
output: 
  html_document:
  toc: TRUE
toc_float: TRUE
author: Ryan Corbett
date: "2024"
---

This script calculates frequency of BRAF fusion breakpoint types by predicted ancestry in pLGG, BRAF fusion subtype patients in the PBTA ancestry cohort 
  
Load libraries and set directories
  
```{r load libraries and set directories}
library(data.table)
library(tidyverse)
library(ComplexHeatmap)
library(circlize)

root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))

data_dir <- file.path(root_dir, "data")
analysis_dir <- file.path(root_dir, "analyses", "braf-fusions")
results_dir <- file.path(analysis_dir, "results")
input_dir <- file.path(analysis_dir, "input")
plot_dir <- file.path(analysis_dir, "plots")

```

Set file paths

```{r}
fusion_file <- file.path(results_dir, "braf-fusions-exon-annotation.tsv")

fusion_dgd_file <- file.path(data_dir, "fusion-dgd.tsv.gz")

cohort_hist_file <- file.path(root_dir, "analyses", "survival", "results", "merged_ancestry_histology_survival.tsv")

hist_file <- file.path(data_dir, "histologies.tsv")

```

Load data

```{r}
braf_hist <- read_tsv(cohort_hist_file) %>%
  dplyr::filter(plot_group == "Low-grade glioma" & (grepl("-BRAF|wildtype|classified", molecular_subtype) | is.na(molecular_subtype))) %>%
  dplyr::mutate(predicted_ancestry = factor(predicted_ancestry))

hist <- read_tsv(hist_file)

# filter fusion file for in-frame fusions and duplications, and determine whether BRAF kinase domain is retained
braf_fusions <- read_tsv(fusion_file) %>%
  dplyr::filter(Fusion_Type == "in-frame",
         grepl("duplication", annots)) %>%
  mutate(keep = case_when(FusionName == "KIAA1549--BRAF" & DomainRetainedGene1B == "Yes" ~ "yes",
                          FusionName == "BRAF--KIAA1549" & DomainRetainedGene1A == "Yes" ~ "yes",
                          TRUE ~ "no")) %>%
  # The below samples have two different common breakpoints and one is low conf in arriba, so we will remove that one
  mutate(keep = case_when(Sample %in% c("BS_SDZY6RZ3", "BS_063ERW0R") & LeftBreakpoint_position == 138867975 ~ "no",
                            TRUE ~ keep))

braf_fusions_dgd <- read_tsv(fusion_dgd_file) %>%
  dplyr::filter(FusionName == "KIAA1549--BRAF" & !grepl("Tier 3|Tier 4", variant_tier)) %>%
  dplyr::rename(Kids_First_Biospecimen_ID = Sample) %>%
  dplyr::select(Kids_First_Biospecimen_ID, FusionName, `5_prime_region`, `3_prime_region`) %>%
  dplyr::mutate(`5_prime_region` = gsub("^Exon |^exon ", "", `5_prime_region`),
         `3_prime_region` = gsub("^Exon |^exon ", "", `3_prime_region`),                        
         breakpoint_exons = paste(`5_prime_region`, `3_prime_region`, sep = ":"),
         breakpoint_type = case_when(breakpoint_exons %in% c("16:9", "15:9", "16:11", "18:10") ~ "common",
                                     TRUE ~ "rare/novel"),
         keep = "yes") %>%
  left_join(hist[,c("Kids_First_Participant_ID", "Kids_First_Biospecimen_ID")])

```

Consolidate all common and rare exon breakpoints per patient

```{r}
common_fusions_pbta <- braf_fusions %>%
  dplyr::filter(breakpoint_exons %in% c("16:9", "15:9", "16:11", "18:10") & keep == "yes") %>%
  distinct(Kids_First_Participant_ID, breakpoint_exons, .keep_all = T) %>%
  group_by(Kids_First_Participant_ID) %>%
  summarise(breakpoint_exons_common = str_c(breakpoint_exons, collapse = ";"))

common_fusions <- braf_fusions_dgd %>%
  dplyr::filter(breakpoint_exons %in% c("16:9", "15:9", "16:11", "18:10") & keep == "yes") %>%
  distinct(Kids_First_Participant_ID, breakpoint_exons, .keep_all = T) %>%
  group_by(Kids_First_Participant_ID) %>%
  summarise(breakpoint_exons_common = str_c(breakpoint_exons, collapse = ";")) %>%
  bind_rows(common_fusions_pbta) %>%
  distinct(Kids_First_Participant_ID, breakpoint_exons_common, .keep_all = T) %>%
  group_by(Kids_First_Participant_ID) %>%
  summarise(breakpoint_exons_common = str_c(breakpoint_exons_common, collapse = ";"))

rare_novel_fusions_pbta <- braf_fusions %>%
  dplyr::filter(!breakpoint_exons %in% c("16:9", "15:9", "16:11", "18:10") & keep == "yes") %>%
  distinct(Kids_First_Participant_ID, breakpoint_exons, .keep_all = T) %>%
  group_by(Kids_First_Participant_ID) %>%
  summarise(breakpoint_exons_rare = str_c(breakpoint_exons, collapse = ";"))

rare_novel_fusions <- braf_fusions_dgd %>%
  dplyr::filter(!breakpoint_exons %in% c("16:9", "15:9", "16:11", "18:10") & keep == "yes") %>%
  distinct(Kids_First_Participant_ID, breakpoint_exons, .keep_all = T) %>%
  group_by(Kids_First_Participant_ID) %>%
  summarise(breakpoint_exons_rare = str_c(breakpoint_exons, collapse = ";")) %>%
  bind_rows(rare_novel_fusions_pbta) %>%
  distinct(Kids_First_Participant_ID, breakpoint_exons_rare, .keep_all = T) %>%
  group_by(Kids_First_Participant_ID) %>%
  summarise(breakpoint_exons_rare = str_c(breakpoint_exons_rare, collapse = ";"))

fusions_all <- common_fusions %>%
  bind_rows(rare_novel_fusions) %>%
  dplyr::mutate(breakpoint_type = case_when(
    !is.na(breakpoint_exons_common) & !is.na(breakpoint_exons_rare) ~ NA_character_,
    !is.na(breakpoint_exons_rare) ~ "rare",
    !is.na(breakpoint_exons_common) ~ "common",
    TRUE ~ NA_character_
  )) %>%
  # Assign breakpoint group (unique common breakpoint or broad rare group)
  dplyr::mutate(breakpoint_group = case_when(
    !is.na(breakpoint_exons_common) & !is.na(breakpoint_exons_rare) ~ NA_character_,
    breakpoint_exons_common == "16:9" ~ "16:9",
    breakpoint_exons_common == "15:9" ~ "15:9",
    breakpoint_exons_common == "16:11" ~ "16:11",
    breakpoint_exons_common == "18:10" ~ "18:10",
    !is.na(breakpoint_exons_rare) ~ "rare",
    TRUE ~ NA_character_
  )) %>%
  write_tsv(file.path(results_dir, "braf-fusion-breakpoints-by-patient.tsv"))



```

Merge breakpoint data to braf hist

```{r}
braf_hist <- braf_hist %>%
  left_join(fusions_all) %>%
  dplyr::filter(!is.na(breakpoint_type))

```

How many patients do we have breakpoint data for? 

```{r}
nrow(braf_hist)

```

```{r}

round(table(braf_hist$predicted_ancestry, braf_hist$breakpoint_type)/as.vector(table(braf_hist$predicted_ancestry)) * 100, 2)

```

## Common breakpoint summary

What is the distribution of common breakpoints by ancestry? 

```{r}

table(braf_hist$breakpoint_exons_common, braf_hist$predicted_ancestry)

```

Calculate fusion breakpoint frequency by predicted ancestry and Fisher's exact test p-value 

```{r}
common_breakpoints <- c("16:9", "15:9", "16:11", "18:10")

common_df <- braf_hist %>%
  dplyr::filter(breakpoint_exons_common %in% common_breakpoints) %>%
  group_by(breakpoint_exons_common, predicted_ancestry) %>%
  summarise(count = n()) %>%
  group_by(predicted_ancestry) %>%
  mutate(total_count = sum(count),
         percentage = round(count / total_count * 100, 1)) %>%
  dplyr::mutate(ct_perc = glue::glue("{count} ({percentage}%)")) %>%
  dplyr::select(breakpoint_exons_common, predicted_ancestry, ct_perc) %>%
  spread(predicted_ancestry, ct_perc, fill = 0)

common_df <- common_df %>%
  mutate(
    p = map_dbl(breakpoint_exons_common, ~round(fisher.test(table(grepl(.x, braf_hist$breakpoint_exons_common), braf_hist$predicted_ancestry))$p.value, 4))
  )

write_tsv(common_df, 
          file.path(results_dir, "lgg-braf-fusion-common-breakpoint-freq.tsv"))

```

Calculate breakpoint group odds ratios and p-values across predicted ancestries, and plot

```{r}
braf_hist <- braf_hist %>%
  dplyr::mutate(AS_ancestry = case_when(
    predicted_ancestry %in% c("EAS", "SAS") ~ "AS",
    TRUE ~ predicted_ancestry
  ))

enr <- matrix(0, length(unique(braf_hist$AS_ancestry)),
              length(unique(braf_hist$breakpoint_group[!is.na(braf_hist$breakpoint_group)])),
              dimnames = list(c("AFR", "AMR", "AS", "EUR"),
                              c("15:9", "16:9", "16:11", "18:10", "rare")))
pval <- enr

# loop through cancer groups to calculate enrichment 
for (i in 1:nrow(enr)){
  no_ancestry <- sum(grepl(rownames(enr)[i], braf_hist$AS_ancestry))
  for (j in 1:ncol(enr)){
    no_group <- sum(braf_hist$breakpoint_group == colnames(enr)[j] & !is.na(braf_hist$breakpoint_group))
    no_anc_group <- sum(braf_hist$AS_ancestry == rownames(enr)[i] & braf_hist$breakpoint_group == colnames(enr)[j])
    enr[i,j] <- (no_anc_group/no_group)/(no_ancestry/nrow(braf_hist))
    pval[i,j] <- phyper(no_anc_group, no_ancestry, nrow(braf_hist) - no_ancestry, no_group, lower.tail = F)
  }
}

enr <- t(enr)
pval <- t(pval)

sig_mat <- ifelse(pval < 0.05 & enr > 1, "*", "")

fill_mat <- matrix(glue::glue("{round(enr, 1)}{sig_mat}"), 
                   nrow(enr), ncol(enr))

count_mat <- table(braf_hist$breakpoint_group, braf_hist$AS_ancestry)
ct_enr_mat <- matrix(glue::glue("{count_mat}\n({fill_mat})"),
                     nrow(count_mat), ncol(count_mat))

col_fun = colorRamp2(c(0, 6), c("white", "orangered"))

# plot enrichment results
pdf(file.path(plot_dir, "breakpoint_group_ancestry_ct_enr_heatmap.pdf"),
    height = 3, width = 6)

ht <- Heatmap(enr,
        name = "Odds ratio",
        cluster_rows = F,
        cluster_columns = F,
        rect_gp = gpar(col = "black", lwd = 2),
        col = col_fun,
        cell_fun = function(j, i, x, y, width, height, fill) {
          grid.text(sprintf("%s", ct_enr_mat[i, j]), x, y, gp = gpar(fontsize = 12))
        })

draw(ht)

invisible(dev.off())

draw(ht)

```

Print rare/novel fusion breakpoint count by predicted ancestry

```{r}
table(braf_hist$breakpoint_exons_rare, braf_hist$predicted_ancestry)

```

Create heatmap of rare breakpoints by ancestry
```{r}

pdf(file.path(plot_dir, "rare_breakpoints_by_ancestry.pdf"),
    height = 3, width = 4)

rare_ct <- table(braf_hist$breakpoint_exons_rare[!is.na(braf_hist$breakpoint_exons_rare)],
                 braf_hist$predicted_ancestry[!is.na(braf_hist$breakpoint_exons_rare)])

rare_ht <- Heatmap(rare_ct,
            name = "Count",
            cluster_rows = F,
            cluster_columns = F,
            rect_gp = gpar(col = "black", lwd = 2),
            col = col_fun,
            cell_fun = function(j, i, x, y, width, height, fill) {
              grid.text(sprintf("%s", rare_ct[i, j]), x, y, gp = gpar(fontsize = 12))
            })

rare_ht

invisible(dev.off())

rare_ht

```

Assess distribution of resection level in patients by breakpoint type (common vs. rare)

```{r}
round(table(braf_hist$breakpoint_type, braf_hist$extent_of_tumor_resection)/as.vector(table(braf_hist$breakpoint_type)), 2)

fisher.test(table(braf_hist$breakpoint_type, braf_hist$extent_of_tumor_resection))

```

Assess distribution of resection level in patients by breakpoint group

```{r}
round(table(braf_hist$breakpoint_group, braf_hist$extent_of_tumor_resection)/as.vector(table(braf_hist$breakpoint_group)), 2)

fisher.test(table(braf_hist$breakpoint_group, braf_hist$extent_of_tumor_resection), simulate.p.value = T)

```

Assess distribution of tumor CNS region in patients by breakpoint type and group

```{r}
round(table(braf_hist$breakpoint_type, braf_hist$CNS_region)/as.vector(table(braf_hist$breakpoint_type)), 3) * 100

fisher.test(table(braf_hist$breakpoint_type, braf_hist$CNS_region))

```


```{r}
round(table(braf_hist$breakpoint_group, braf_hist$CNS_region)/as.vector(table(braf_hist$breakpoint_group)), 3) * 100

fisher.test(table(braf_hist$breakpoint_group, braf_hist$CNS_region), simulate.p.value = T)

```

Confirm that CNS region and degree of tumor resection are significantly associated: 

```{r}
round(table(braf_hist$CNS_region, braf_hist$extent_of_tumor_resection)/as.vector(table(braf_hist$CNS_region)), 3) * 100

fisher.test(table(braf_hist$CNS_region, braf_hist$extent_of_tumor_resection), simulate.p.value= T)

```

Save braf-specific hist file with breakpoint annotation 

```{r}
write_tsv(braf_hist,
          file.path(results_dir, "lgg-braf-fusion-breakpoint-annotation.tsv"))

```

Print session info

```{r}
sessionInfo()

```